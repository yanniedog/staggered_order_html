<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Plan Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #cde7ec;
            color: #273f43;
        }
        .form-input {
            background-color: #f8fafa;
            border: 1px solid #dbf6fa;
            color: #273f43;
            transition: all 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #00424a;
            box-shadow: 0 0 0 3px rgba(0, 66, 74, 0.1);
        }
        .btn-primary {
            background-color: #00424a;
            color: #edfcff;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #005f6b;
        }
        .btn-secondary {
            background-color: #006b5e; /* sell-bar color */
            color: #edfcff;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #008a7b; /* sell-bar hover */
        }
        .card {
            background-color: #edfcff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .summary-card {
            background-color: #dbf6fa;
            border-left: 4px solid #00424a;
        }
        .table-header {
            background-color: #dbf6fa;
        }
        .table-row-odd {
            background-color: #edfcff;
        }
        .table-row-even {
            background-color: #f8fafa;
        }
        /* Custom slider styles */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #bac6ea;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type=range]:hover {
            opacity: 1;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #00424a;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #edfcff;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #00424a;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #edfcff;
        }
        .d3-chart .domain {
            stroke: #2f3b58;
        }
        .d3-chart .tick line {
            stroke: #bac6ea;
        }
        .d3-chart .tick text {
            fill: #2f3b58;
            font-size: 11px; /* Slightly smaller for price labels */
        }
        .d3-chart .grid line {
            stroke: #bac6ea;
            stroke-opacity: 0.5;
            shape-rendering: crispEdges;
        }
        .d3-chart .buy-bar {
            fill: #2f3b58;
            transition: all 0.3s ease-out;
        }
        .d3-chart .buy-bar:hover {
            fill: #00424a;
        }
        .d3-chart .sell-bar {
            fill: #006b5e; /* New color for sell chart */
            transition: all 0.3s ease-out;
        }
        .d3-chart .sell-bar:hover {
            fill: #008a7b; /* New hover color for sell chart */
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            background: #00424a;
            color: #edfcff;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body class="p-2 sm:p-4">
    <div id="app" class="max-w-7xl mx-auto">
        <header class="text-center py-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-primary-dark">Trading Plan Calculator</h1>
            <p class="text-secondary-dark mt-2 text-md sm:text-lg">Design your buy and sell ladders with precision.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            <div class="lg:col-span-1">
                <div class="card p-6 sticky top-4">
                    <h2 class="text-2xl font-semibold text-primary-dark mb-6">Configuration</h2>
                    <form id="trading-plan-form" class="space-y-5">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="starting_capital" class="block text-sm font-medium text-secondary-dark mb-1">Starting Capital ($)</label>
                                <input type="number" id="starting_capital" value="50000" class="form-input w-full rounded-md p-2">
                            </div>
                            <div>
                                <label for="current_price" class="block text-sm font-medium text-secondary-dark mb-1">Current Price ($)</label>
                                <input type="number" id="current_price" value="100" class="form-input w-full rounded-md p-2">
                            </div>
                        </div>
                        <div>
                            <label for="number_of_rungs" class="block text-sm font-medium text-secondary-dark mb-1">Number of Rungs (<span id="number_of_rungs_display">10</span>)</label>
                            <input type="range" id="number_of_rungs" value="10" min="2" max="50" step="1" class="w-full h-2 rounded-lg cursor-pointer">
                        </div>
                        <div>
                            <label for="depth" class="block text-sm font-medium text-secondary-dark mb-1">Depth (<span id="depth_display">20</span>%)</label>
                            <input type="range" id="depth" value="20" min="1" max="100" step="1" class="w-full h-2 rounded-lg cursor-pointer">
                        </div>
                        <div>
                            <label for="skew_value" class="block text-sm font-medium text-secondary-dark mb-1">Capital/Asset Skew (<span id="skew_value_display">50</span>)</label>
                            <input type="range" id="skew_value" min="0" max="100" value="50" class="w-full h-2 rounded-lg cursor-pointer">
                            <div class="flex justify-between text-xs text-tertiary-dark mt-1">
                                <span>Front-load</span>
                                <span>Linear</span>
                                <span>Back-load</span>
                            </div>
                        </div>
                        <!-- Removed Generate Plan button -->
                    </form>
                </div>
            </div>

            <div id="results-panel" class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-primary-dark">Plan Summary</h2>
                        <button id="download-csv-btn" class="btn-secondary text-sm font-medium py-2 px-4 rounded-lg">
                            Download CSV
                        </button>
                    </div>
                    <div id="summary" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 text-center">
                        <div class="summary-card p-4 rounded-lg">
                            <p class="text-sm text-secondary-dark">Avg. Buy Price</p>
                            <p id="summary-avg-buy" class="text-xl font-bold text-primary-dark">-</p>
                        </div>
                        <div class="summary-card p-4 rounded-lg">
                            <p class="text-sm text-secondary-dark">Avg. Sell Price</p>
                            <p id="summary-avg-sell" class="text-xl font-bold text-primary-dark">-</p>
                        </div>
                        <div class="summary-card p-4 rounded-lg">
                            <p class="text-sm text-secondary-dark">Total Profit</p>
                            <p id="summary-total-profit" class="text-xl font-bold text-primary-dark">-</p>
                        </div>
                        <div class="summary-card p-4 rounded-lg">
                            <p class="text-sm text-secondary-dark">Total Asset</p>
                            <p id="summary-total-asset" class="text-xl font-bold text-primary-dark">-</p>
                        </div>
                        <div class="summary-card p-4 rounded-lg">
                            <p class="text-sm text-secondary-dark">Actual ROI</p>
                            <p id="summary-roi" class="text-xl font-bold text-primary-dark">-</p>
                        </div>
                    </div>
                </div>

                <!-- Buy Chart -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold text-primary-dark mb-4">Capital Allocation Across Buy Rungs</h3>
                    <div id="visualization" class="d3-chart">
                        <svg id="allocation-chart"></svg>
                    </div>
                </div>
                
                <!-- Sell Chart -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold text-primary-dark mb-4">Asset Allocation Across Sell Rungs</h3>
                    <div id="sell-visualization" class="d3-chart">
                        <svg id="sell-allocation-chart"></svg>
                    </div>
                </div>

                <!-- Updated grid to md:grid-cols-2 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-primary-dark mb-4">Buy Ladder</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-primary-dark uppercase table-header">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 rounded-l-lg">Rung</th>
                                        <th scope="col" class="px-4 py-3">Price</th>
                                        <th scope="col" class="px-4 py-3">Capital</th>
                                        <th scope="col" class="px-4 py-3">Allocation</th>
                                        <th scope="col" class="px-4 py-3 rounded-r-lg">Asset Size</th>
                                    </tr>
                                </thead>
                                <tbody id="buy-ladder-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-primary-dark mb-4">Sell Ladder</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-primary-dark uppercase table-header">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 rounded-l-lg">Rung</th>
                                        <th scope="col" class="px-4 py-3">Price</th>
                                        <th scope="col" class="px-4 py-3">Capital</th>
                                        <th scope="col" class="px-4 py-3">Allocation</th>
                                        <th scope="col" class="px-4 py-3">Asset Size</th>
                                        <th scope="col" class="px-4 py-3 rounded-r-lg">Profit</th>
                                    </tr>
                                </thead>
                                <tbody id="sell-ladder-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="tooltip" class="tooltip"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Store plan data for CSV export
            let currentPlanData = null;

            const form = document.getElementById('trading-plan-form');
            const skewSlider = document.getElementById('skew_value');
            const skewDisplay = document.getElementById('skew_value_display');
            const rungSlider = document.getElementById('number_of_rungs');
            const depthSlider = document.getElementById('depth');
            const rungDisplay = document.getElementById('number_of_rungs_display');
            const depthDisplay = document.getElementById('depth_display');

            const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
            const formatPercent = (value) => `${value.toFixed(2)}%`;
            const formatNumber = (value, digits = 4) => value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: digits });

            // Custom alert box
            function showModalAlert(message) {
                // Check if an alert already exists
                if (document.getElementById('custom-alert')) {
                    return;
                }

                let alertOverlay = document.createElement('div');
                alertOverlay.id = 'custom-alert-overlay';
                alertOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4';
                
                let alertBox = document.createElement('div');
                alertBox.id = 'custom-alert';
                alertBox.className = 'bg-white rounded-lg shadow-xl p-6 w-full max-w-md z-50';
                
                let alertTitle = document.createElement('h3');
                alertTitle.className = 'text-lg font-medium text-gray-900 mb-4';
                alertTitle.textContent = 'Invalid Input';
                
                let alertMessage = document.createElement('p');
                alertMessage.className = 'text-sm text-gray-600 mb-6';
                alertMessage.textContent = message;
                
                let alertButton = document.createElement('button');
                alertButton.id = 'custom-alert-close';
                alertButton.className = 'w-full px-4 py-2 btn-primary rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500';
                alertButton.textContent = 'OK';
                
                alertButton.onclick = function() {
                    document.body.removeChild(alertOverlay);
                };
                
                alertBox.appendChild(alertTitle);
                alertBox.appendChild(alertMessage);
                alertBox.appendChild(alertButton);
                alertOverlay.appendChild(alertBox);
                document.body.appendChild(alertOverlay);

                alertButton.focus();
            }


            function calculatePlan() {
                // 1. Get inputs
                const C = parseFloat(document.getElementById('starting_capital').value);
                const N = parseInt(document.getElementById('number_of_rungs').value);
                const S = parseInt(document.getElementById('skew_value').value);
                const currentPrice = parseFloat(document.getElementById('current_price').value);
                const depth = parseFloat(document.getElementById('depth').value);

                if ([C, N, S, currentPrice, depth].some(isNaN)) {
                    // Don't show alert on load if fields are empty, only if they are invalid
                     if (document.activeElement && document.activeElement.closest('form')) {
                         showModalAlert("Please ensure all inputs are valid numbers.");
                     }
                    return;
                }
                
                if (depth <= 0) {
                    // showModalAlert("Depth must be a positive percentage.");
                    return; // Fail silently on real-time update
                }
                if (currentPrice <= 0) {
                    // showModalAlert("Current Price must be positive.");
                    return; // Fail silently on real-time update
                }
                if (N < 2) {
                    //  showModalAlert("Number of rungs must be at least 2.");
                    return; // Fail silently on real-time update
                }

                // 2. Calculate Skew Weights
                // SkewParam > 1 for Back-load (S > 50), < 1 for Front-load (S < 50)
                const skewParam = Math.pow(10, (S - 50) / 50);
                let rawWeights = Array.from({ length: N }, (_, i) => Math.pow(i + 1, skewParam));
                const totalWeight = rawWeights.reduce((sum, w) => sum + w, 0);
                
                // 3. Calculate Capital Allocation (Buy Side)
                // More capital at later rungs (lower prices) if back-loaded
                const capitalAllocations = rawWeights.map(w => C * (w / totalWeight));

                // 4. Calculate Price Points
                const depthVal = depth / 100;
                
                const buyPriceEnd = currentPrice * (1 - depthVal);
                const sellPriceEnd = currentPrice * (1 + depthVal);

                // NEW LOGIC for spacing
                // The total price range for buys is from currentPrice down to buyPriceEnd
                const buyRange = currentPrice - buyPriceEnd;
                // Divide this range into N equal steps (intervals)
                const buyPriceStep = N > 0 ? buyRange / N : 0; 
                
                // The total price range for sells is from currentPrice up to sellPriceEnd
                const sellRange = sellPriceEnd - currentPrice;
                // Divide this range into N equal steps
                const sellPriceStep = N > 0 ? sellRange / N : 0;

                // 5. Calculate Buy Ladder
                const buyLadder = capitalAllocations.map((capital, i) => {
                    // Rung 1 (i=0) is at currentPrice - (1 * step)
                    // Rung N (i=N-1) is at currentPrice - (N * step) == buyPriceEnd
                    const price = currentPrice - ((i + 1) * buyPriceStep); 
                    const assetSize = price > 0 ? capital / price : 0;
                    return {
                        rung: i + 1,
                        price,
                        capital,
                        allocation: (capital / C) * 100,
                        assetSize
                    };
                });

                // 6. Calculate Average Entry & Total Asset
                const totalAssetBought = buyLadder.reduce((sum, rung) => sum + rung.assetSize, 0);
                const avgBuyPrice = totalAssetBought > 0 ? C / totalAssetBought : 0;

                // 7. Calculate Sell Ladder
                // Symmetrical asset allocation: more assets sold at later rungs (higher prices) if back-loaded
                const assetAllocations = rawWeights.map(w => totalAssetBought * (w / totalWeight));

                let sellLadder = assetAllocations.map((assetSize, i) => {
                    // Rung 1 (i=0) is at currentPrice + (1 * step)
                    // Rung N (i=N-1) is at currentPrice + (N * step) == sellPriceEnd
                    const price = currentPrice + ((i + 1) * sellPriceStep);
                    const profit = (price - avgBuyPrice) * assetSize;
                    const capital = assetSize * price;
                    return {
                        rung: i + 1,
                        price,
                        assetSize: assetSize,
                        profit,
                        capital,
                        allocation: 0 // Will calculate this next
                    };
                });

                // 8. Calculate Sell Ladder Allocations
                const totalSellCapital = sellLadder.reduce((sum, r) => sum + r.capital, 0);
                const avgSellPrice = totalAssetBought > 0 ? totalSellCapital / totalAssetBought : 0;
                sellLadder.forEach(rung => {
                    rung.allocation = totalSellCapital > 0 ? (rung.capital / totalSellCapital) * 100 : 0;
                });

                // 9. Final Summary
                const totalProfit = sellLadder.reduce((sum, rung) => sum + rung.profit, 0);
                const actualROI = C > 0 ? (totalProfit / C) * 100 : 0;

                const plan = {
                    summary: { 
                        avgBuyPrice: avgBuyPrice,
                        avgSellPrice: avgSellPrice,
                        totalProfit, 
                        totalAssetBought, 
                        actualROI 
                    },
                    buyLadder,
                    sellLadder
                };
                
                updateUI(plan);
            }

            function updateUI(plan) {
                // Store data for CSV export
                currentPlanData = plan;

                // Update summary cards
                document.getElementById('summary-avg-buy').textContent = formatCurrency(plan.summary.avgBuyPrice);
                document.getElementById('summary-avg-sell').textContent = formatCurrency(plan.summary.avgSellPrice);
                document.getElementById('summary-total-profit').textContent = formatCurrency(plan.summary.totalProfit);
                document.getElementById('summary-total-asset').textContent = formatNumber(plan.summary.totalAssetBought);
                document.getElementById('summary-roi').textContent = formatPercent(plan.summary.actualROI);

                // Update tables
                const buyBody = document.getElementById('buy-ladder-body');
                const sellBody = document.getElementById('sell-ladder-body');
                buyBody.innerHTML = '';
                sellBody.innerHTML = '';

                plan.buyLadder.forEach((rung, i) => {
                    const rowClass = i % 2 === 0 ? 'table-row-even' : 'table-row-odd';
                    buyBody.innerHTML += `
                        <tr class="${rowClass}">
                            <td class="px-4 py-2 font-medium">${rung.rung}</td>
                            <td class="px-4 py-2">${formatCurrency(rung.price)}</td>
                            <td class="px-4 py-2">${formatCurrency(rung.capital)}</td>
                            <td class="px-4 py-2">${formatPercent(rung.allocation)}</td>
                            <td class="px-4 py-2">${formatNumber(rung.assetSize)}</td>
                        </tr>`;
                });

                plan.sellLadder.forEach((rung, i) => {
                    const rowClass = i % 2 === 0 ? 'table-row-even' : 'table-row-odd';
                    sellBody.innerHTML += `
                        <tr class="${rowClass}">
                            <td class="px-4 py-2 font-medium">${rung.rung}</td>
                            <td class="px-4 py-2">${formatCurrency(rung.price)}</td>
                            <td class="px-4 py-2">${formatCurrency(rung.capital)}</td>
                            <td class="px-4 py-2">${formatPercent(rung.allocation)}</td>
                            <td class="px-4 py-2">${formatNumber(rung.assetSize)}</td>
                            <td class="px-4 py-2">${formatCurrency(rung.profit)}</td>
                        </tr>`;
                });
                
                // Draw both charts
                drawBuyChart(plan.buyLadder);
                drawSellChart(plan.sellLadder);
            }
            
            function drawBuyChart(data) {
                const container = d3.select("#visualization");
                if (container.node() === null) return; 

                d3.select("#allocation-chart").selectAll("*").remove();

                const margin = { top: 20, right: 20, bottom: 70, left: 60 }; // Increased bottom margin
                let width;
                try {
                    width = container.node().getBoundingClientRect().width - margin.left - margin.right;
                } catch (e) {
                    console.error("Could not get container width:", e);
                    width = 500 - margin.left - margin.right; // Fallback width
                }
                width = Math.max(width, 100); // Ensure width is positive
                const height = 300 - margin.top - margin.bottom;

                const svg = d3.select("#allocation-chart")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                    .range([0, width])
                    .domain(data.map(d => d.price)) // X-axis is now price
                    .padding(0.2);

                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d => formatCurrency(parseFloat(d))))
                    .selectAll("text")
                        .style("text-anchor", "end")
                        .attr("dx", "-.8em")
                        .attr("dy", ".15em")
                        .attr("transform", "rotate(-45)"); // Rotate labels
                
                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("x", width / 2)
                    .attr("y", height + margin.bottom - 10) // Adjusted y
                    .text("Buy Price")
                    .style("fill", "#2f3b58")
                    .style("font-size", "12px");

                const yMax = d3.max(data, d => d.capital);
                const y = d3.scaleLinear()
                    .domain([0, yMax > 0 ? yMax : 1]) 
                    .range([height, 0]);

                svg.append("g")
                    .call(d3.axisLeft(y).ticks(5).tickFormat(d => `$${d3.format(".2s")(d).replace(/G/, "B")}`));

                svg.append("text")
                    .attr("text-anchor", "end")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 20)
                    .attr("x", -height / 2 + 20)
                    .text("Capital ($)")
                    .style("fill", "#2f3b58")
                    .style("font-size", "12px");

                const tooltip = d3.select("#tooltip");

                svg.selectAll(".buy-bar")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class", "buy-bar")
                    .attr("x", d => x(d.price)) // Use price for x
                    .attr("width", x.bandwidth())
                    .attr("y", d => y(0))
                    .attr("height", d => height - y(0))
                    .on("mouseover", function(event, d) {
                        tooltip.style("opacity", 1);
                        d3.select(this).style("opacity", 0.7);
                    })
                    .on("mousemove", function(event, d) {
                        tooltip.html(`Rung ${d.rung}<br>Price: ${formatCurrency(d.price)}<br>Capital: ${formatCurrency(d.capital)}<br>Allocation: ${formatPercent(d.allocation)}`)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        tooltip.style("opacity", 0);
                        d3.select(this).style("opacity", 1);
                    });

                svg.selectAll("rect.buy-bar")
                    .transition()
                    .duration(800)
                    .attr("y", d => y(d.capital))
                    .attr("height", d => height - y(d.capital))
                    .delay((d, i) => i * 20);
            }

            function drawSellChart(data) {
                const container = d3.select("#sell-visualization");
                if (container.node() === null) return; 

                d3.select("#sell-allocation-chart").selectAll("*").remove();

                const margin = { top: 20, right: 20, bottom: 70, left: 60 }; // Increased bottom margin
                let width;
                try {
                     width = container.node().getBoundingClientRect().width - margin.left - margin.right;
                } catch (e) {
                    console.error("Could not get container width:", e);
                    width = 500 - margin.left - margin.right; // Fallback width
                }
                width = Math.max(width, 100); // Ensure width is positive
                const height = 300 - margin.top - margin.bottom;

                const svg = d3.select("#sell-allocation-chart")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                    .range([0, width])
                    .domain(data.map(d => d.price)) // X-axis is now price
                    .padding(0.2);

                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d => formatCurrency(parseFloat(d))))
                    .selectAll("text")
                        .style("text-anchor", "end")
                        .attr("dx", "-.8em")
                        .attr("dy", ".15em")
                        .attr("transform", "rotate(-45)"); // Rotate labels
                
                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("x", width / 2)
                    .attr("y", height + margin.bottom - 10) // Adjusted y
                    .text("Sell Price")
                    .style("fill", "#2f3b58")
                    .style("font-size", "12px");

                const yMax = d3.max(data, d => d.assetSize);
                const y = d3.scaleLinear()
                    .domain([0, yMax > 0 ? yMax : 1]) 
                    .range([height, 0]);

                svg.append("g")
                    .call(d3.axisLeft(y).ticks(5).tickFormat(d => `${d3.format(".2s")(d).replace(/G/, "B")}`));

                svg.append("text")
                    .attr("text-anchor", "end")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 20)
                    .attr("x", -height / 2 + 20)
                    .text("Asset Size")
                    .style("fill", "#2f3b58")
                    .style("font-size", "12px");

                const tooltip = d3.select("#tooltip");

                svg.selectAll(".sell-bar")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class", "sell-bar")
                    .attr("x", d => x(d.price)) // Use price for x
                    .attr("width", x.bandwidth())
                    .attr("y", d => y(0))
                    .attr("height", d => height - y(0))
                    .on("mouseover", function(event, d) {
                        tooltip.style("opacity", 1);
                        d3.select(this).style("opacity", 0.7);
                    })
                    .on("mousemove", function(event, d) {
                        tooltip.html(`Rung ${d.rung}<br>Price: ${formatCurrency(d.price)}<br>Asset: ${formatNumber(d.assetSize)}<br>Capital: ${formatCurrency(d.capital)}<br>Allocation: ${formatPercent(d.allocation)}`)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        tooltip.style("opacity", 0);
                        d3.select(this).style("opacity", 1);
                    });

                svg.selectAll("rect.sell-bar")
                    .transition()
                    .duration(800)
                    .attr("y", d => y(d.assetSize))
                    .attr("height", d => height - y(d.assetSize))
                    .delay((d, i) => i * 20);
            }

            // --- Real-time updates ---

            // Debounce function
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }

            // Debounced calculate function for number inputs
            const debouncedCalculate = debounce(calculatePlan, 300); // 300ms delay

            // Add listeners to number inputs
            const inputsToTrack = [
                'starting_capital',
                'current_price'
            ];

            inputsToTrack.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', debouncedCalculate);
                }
            });

            // The skew slider updates instantly
            skewSlider.addEventListener('input', (e) => {
                skewDisplay.textContent = e.target.value;
                calculatePlan(); 
            });

            if (rungSlider && rungDisplay) {
                rungSlider.addEventListener('input', (e) => {
                    rungDisplay.textContent = e.target.value;
                    calculatePlan();
                });
                rungDisplay.textContent = rungSlider.value;
            }

            if (depthSlider && depthDisplay) {
                depthSlider.addEventListener('input', (e) => {
                    depthDisplay.textContent = e.target.value;
                    calculatePlan();
                });
                depthDisplay.textContent = depthSlider.value;
            }
            
            // --- CSV Download ---
            const downloadBtn = document.getElementById('download-csv-btn');
            downloadBtn.addEventListener('click', () => {
                if (!currentPlanData) {
                    showModalAlert("No data to download. Adjust settings to generate a plan.");
                    return;
                }

                const plan = currentPlanData;
                
                // Get settings
                const settings = {
                    date: new Date().toLocaleString(),
                    startingCapital: document.getElementById('starting_capital').value,
                    rungs: document.getElementById('number_of_rungs').value,
                    currentPrice: document.getElementById('current_price').value,
                    depth: document.getElementById('depth').value,
                    skew: document.getElementById('skew_value').value
                };

                let csvContent = "";

                // Section 1: Settings
                csvContent += "Setting,Value\r\n";
                csvContent += `Date,"${settings.date}"\r\n`;
                csvContent += `Starting Capital,${settings.startingCapital}\r\n`;
                csvContent += `Number of Rungs,${settings.rungs}\r\n`;
                csvContent += `Current Price,${settings.currentPrice}\r\n`;
                csvContent += `Depth (%),${settings.depth}\r\n`;
                csvContent += `Skew,${settings.skew}\r\n`;
                csvContent += "\r\n";

                // Section 2: Summary
                csvContent += "Summary Metric,Value\r\n";
                csvContent += `Avg. Buy Price,${plan.summary.avgBuyPrice}\r\n`;
                csvContent += `Avg. Sell Price,${plan.summary.avgSellPrice}\r\n`;
                csvContent += `Total Profit,${plan.summary.totalProfit}\r\n`;
                csvContent += `Total Asset,${plan.summary.totalAssetBought}\r\n`;
                csvContent += `Actual ROI (%),${plan.summary.actualROI}\r\n`;
                csvContent += "\r\n";

                // Section 3: Ladders
                csvContent += "Buy Rung,Buy Price,Buy Capital,Buy Allocation (%),Buy Asset Size,,Sell Rung,Sell Price,Sell Capital,Sell Allocation (%),Sell Asset Size,Sell Profit\r\n";
                
                const numRungs = plan.buyLadder.length; // Assumes buy and sell have same length
                for (let i = 0; i < numRungs; i++) {
                    const buyRung = plan.buyLadder[i];
                    const sellRung = plan.sellLadder[i];
                    
                    const buyRow = [
                        buyRung.rung,
                        buyRung.price,
                        buyRung.capital,
                        buyRung.allocation,
                        buyRung.assetSize
                    ].join(',');
                    
                    const sellRow = [
                        sellRung.rung,
                        sellRung.price,
                        sellRung.capital,
                        sellRung.allocation,
                        sellRung.assetSize,
                        sellRung.profit
                    ].join(',');

                    csvContent += `${buyRow},,${sellRow}\r\n`;
                }

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `trading_plan_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });


            // --- Resize and Initial Load ---
            
            // Debounce resize event
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    // Only calculate if we have valid data
                    if (currentPlanData) {
                        calculatePlan();
                    }
                }, 250); // Redraw 250ms after resize events stop
            });

            // Initial calculation on page load
            calculatePlan();
            
        });
    </script>
</body>
</html>